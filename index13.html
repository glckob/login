<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ប្រព័ន្ធគ្រប់គ្រងវេរប្រាក់ (Money Transfer)</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hanuman:wght@100;300;400;700;900&display=swap" rel="stylesheet">

    <!-- Styles -->
    <style>
        body { font-family: 'Hanuman', sans-serif, ui-sans-serif, system-ui; background-color: #f0f2f5; } 
        input, select, button { touch-action: manipulation; } 
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1877f2; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        input:focus, select:focus, textarea:focus { border-color: #1877f2; outline: none; ring: 2px; --tw-ring-color: #bfdbfe; }
        
        /* Modal Styles */
        #custom-modal { transition: opacity 0.2s ease-in-out; }
        .modal-hidden { opacity: 0; pointer-events: none; }
        .modal-visible { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>

    <!-- App Container -->
    <div id="app" class="min-h-screen flex flex-col"></div>

    <!-- Custom Modal/Dialog Component -->
    <div id="custom-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center modal-hidden p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-2">ចំណងជើង</h3>
            <p id="modal-message" class="text-gray-600 mb-6 leading-relaxed">ខ្លឹមសារសារ...</p>
            <div class="flex flex-col sm:flex-row justify-end gap-3">
                <button id="modal-confirm" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-bold shadow-lg shadow-blue-200">យល់ព្រម</button>
                <button id="modal-cancel" class="w-full sm:w-auto px-6 py-3 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition font-medium">បោះបង់</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const supabaseUrl = 'https://uafiagvtvrukjknoviqq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhZmlhZ3Z0dnJ1a2prbm92aXFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MDM3NDEsImV4cCI6MjA3OTk3OTc0MX0.DaF6FE34R5mcHZWvXGnoIfbzMJWwtATb1_aZ52QKVmU';
        
        const { createClient } = window.supabase;
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- STATE ---
        const state = {
            session: null,
            role: null,
            activeTab: 'deposit', 
            transactions: [],
            loading: true,
            authMode: 'login',
            showForm: false,
            banks: [],
            currencies: [],
            posts: [],
            users: [],
            editingTx: null,
            editingSetting: null,
            filterUser: '' 
        };

        // --- CUSTOM DIALOG SYSTEM ---
        const dialog = {
            show: (title, message, isConfirm = false, onConfirm = null, onClose = null) => {
                const modal = document.getElementById('custom-modal');
                const titleEl = document.getElementById('modal-title');
                const msgEl = document.getElementById('modal-message');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                titleEl.innerText = title;
                msgEl.innerText = message;

                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                const handleClose = () => {
                    modal.classList.replace('modal-visible', 'modal-hidden');
                    if (onClose) onClose();
                };

                if (isConfirm) {
                    newCancelBtn.style.display = 'block';
                    newCancelBtn.onclick = handleClose;
                    
                    newConfirmBtn.innerText = 'យល់ព្រម';
                    newConfirmBtn.className = "w-full sm:w-auto px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-bold shadow-lg shadow-red-200";
                    newConfirmBtn.onclick = () => {
                        modal.classList.replace('modal-visible', 'modal-hidden');
                        if (onConfirm) onConfirm();
                    };
                } else {
                    newCancelBtn.style.display = 'none';
                    newConfirmBtn.innerText = 'បិទ';
                    newConfirmBtn.className = "w-full sm:w-auto px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-bold shadow-lg shadow-blue-200";
                    newConfirmBtn.onclick = handleClose;
                }

                modal.classList.replace('modal-hidden', 'modal-visible');
            }
        };
        const showAlert = (title, msg, onClose) => dialog.show(title, msg, false, null, onClose);
        const showConfirm = (title, msg, callback, onClose) => dialog.show(title, msg, true, callback, onClose);


        // --- INITIALIZATION ---
        async function initApp() {
            renderLoading();
            const { data: { session } } = await supabase.auth.getSession();
            state.session = session;

            if (session) {
                await fetchRole(session.user.id);
            } else {
                state.loading = false;
                renderAuth();
            }

            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'TOKEN_REFRESHED') {
                    state.session = session;
                    return;
                }
                if (event === 'SIGNED_IN' && state.session?.user?.id === session?.user?.id && state.role) {
                    state.session = session;
                    return;
                }

                state.session = session;
                if (session) {
                    state.loading = true;
                    renderLoading();
                    await fetchRole(session.user.id);
                } else {
                    state.role = null;
                    state.loading = false;
                    renderAuth();
                }
            });
        }

        async function fetchRole(userId) {
            try {
                const { data } = await supabase.from('profiles').select('role').eq('id', userId).single();
                state.role = data ? data.role : 'user';
                
                if (state.role !== 'admin') {
                    state.activeTab = 'quick_withdraw';
                } else {
                    state.activeTab = 'deposit'; 
                }

            } catch (error) {
                console.error('Error fetching role:', error);
                state.role = 'user';
                state.activeTab = 'quick_withdraw';
            } finally {
                await Promise.all([fetchBanks(), fetchPosts(), fetchCurrencies()]);
                state.loading = false;
                renderDashboard();
                fetchTransactions();
            }
        }

        // --- FETCH DATA ---
        async function fetchBanks() { const { data } = await supabase.from('banks').select('*').order('name'); state.banks = data || []; }
        async function fetchCurrencies() { const { data } = await supabase.from('currencies').select('*').order('code'); state.currencies = data || []; }
        async function fetchPosts() { const { data } = await supabase.from('posts').select('*').order('created_at', { ascending: false }); state.posts = data || []; }

        async function fetchUsers() { 
            if(state.role !== 'admin') return;
            const { data } = await supabase.from('profiles').select('*').order('email'); 
            state.users = data || []; 
        }

        async function fetchTransactions() {
            if (state.activeTab === 'settings' || state.activeTab === 'quick_withdraw') return;
            
            const currentTab = state.activeTab;
            const tableBody = document.getElementById('transaction-table-body');
            
            // Only show loading if we are NOT on reports page to avoid UI flickering on summaries
            if (currentTab !== 'withdraw_reports' && tableBody) {
                tableBody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-gray-500">កំពុងទាញទិន្នន័យ...</td></tr>';
            }

            const { data, error } = await supabase
                .from('transactions')
                .select('*')
                .eq('transaction_type', currentTab === 'withdraw_reports' ? 'withdraw' : currentTab)
                .order('created_at', { ascending: false });

            if (state.activeTab !== currentTab) return;

            if (!error) {
                state.transactions = data;
                // FIX: If on Reports page, we MUST re-render the whole dashboard content to update Summary Cards
                if (currentTab === 'withdraw_reports') {
                    renderDashboardContent();
                } else {
                    renderTransactionTable();
                }
            } else {
                if(tableBody) tableBody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-red-500">មានបញ្ហា: ${error.message}</td></tr>`;
            }
        }

        // --- ACTIONS ---
        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('auth-btn');
            
            btn.disabled = true;
            btn.innerText = 'កំពុងដំណើរការ...';

            try {
                let result;
                if (state.authMode === 'login') result = await supabase.auth.signInWithPassword({ email, password });
                else result = await supabase.auth.signUp({ email, password });

                if (result.error) throw result.error;
                if (state.authMode === 'signup' && result.data) {
                    showAlert('ជោគជ័យ', "ចុះឈ្មោះជោគជ័យ! សូមចូលប្រើប្រាស់។");
                    state.authMode = 'login';
                    renderAuth();
                }
            } catch (err) {
                showAlert('បរាជ័យ', err.message);
                btn.disabled = false;
                btn.innerText = state.authMode === 'login' ? 'ចូលប្រើប្រាស់' : 'ចុះឈ្មោះ';
            }
        }

        async function handleLogout() { await supabase.auth.signOut(); }

        // --- CRUD ACTIONS: TRANSACTIONS ---

        window.editTransaction = (txId) => {
            const tx = state.transactions.find(t => t.id === txId);
            if(tx) {
                state.editingTx = tx;
                state.showForm = true;
                renderDashboardContent();
            }
        };

        window.deleteTransaction = (txId) => {
            showConfirm('លុបទិន្នន័យ', 'តើអ្នកពិតជាចង់លុបទិន្នន័យនេះមែនទេ? សកម្មភាពនេះមិនអាចត្រឡប់វិញបានទេ។', async () => {
                const { error } = await supabase.from('transactions').delete().eq('id', txId);
                if(error) {
                    showAlert('បរាជ័យ', 'មិនអាចលុបបានទេ: ' + error.message);
                } else {
                    showAlert('ជោគជ័យ', 'លុបទិន្នន័យជោគជ័យ');
                    fetchTransactions();
                }
            });
        };

        // --- UTILS ---
        function focusInput(id) {
            setTimeout(() => {
                const el = document.getElementById(id);
                if (el) {
                    el.focus();
                    if(el.select) el.select();
                }
            }, 100);
        }

        window.setFilterUser = (email) => {
            state.filterUser = email;
            renderDashboardContent(); // Re-render to update summary and table
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-tx-btn');
            btn.disabled = true; btn.innerText = 'កំពុងដំណើរការ...';

            const isEditing = !!state.editingTx;
            const isQuickWithdraw = state.activeTab === 'quick_withdraw';

            // --- A. QUICK WITHDRAW (Create Only) ---
            if (isQuickWithdraw && !isEditing) {
                const invoiceNumber = document.getElementById('withdraw_invoice').value.trim();
                
                if (!invoiceNumber) {
                    showAlert('ជូនដំណឹង', 'សូមបញ្ចូលលេខវិក្កយបត្រ', () => focusInput('withdraw_invoice'));
                    btn.disabled = false; btn.innerText = 'ទូទាត់ដកប្រាក់';
                    return;
                }

                const { data: depositRecord, error: searchError } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('transaction_type', 'deposit')
                    .eq('invoice_number', invoiceNumber)
                    .eq('status', 'pending')
                    .single();

                if (searchError || !depositRecord) {
                    showAlert('បរាជ័យ', 'រកមិនឃើញវិក្កយបត្រនេះទេ (INV: ' + invoiceNumber + ') ឬទឹកប្រាក់ត្រូវបានដករួចរាល់ហើយ។', () => focusInput('withdraw_invoice'));
                    btn.disabled = false; btn.innerText = 'ទូទាត់ដកប្រាក់';
                    document.getElementById('withdraw_invoice').value = '';
                    return;
                }

                const confirmMsg = `រកឃើញវិក្កយបត្រ: ${depositRecord.invoice_number}\nទឹកប្រាក់: $${depositRecord.amount} ${depositRecord.currency || ''}\nឈ្មោះ: ${depositRecord.account_name}\n\nតើអ្នកចង់ធ្វើការដកប្រាក់នេះមែនទេ?`;
                
                showConfirm('បញ្ជាក់ការដកប្រាក់', confirmMsg, async () => {
                    const { error: insertError } = await supabase.from('transactions').insert([{
                        transaction_type: 'withdraw',
                        invoice_number: depositRecord.invoice_number,
                        amount: depositRecord.amount,
                        account_name: depositRecord.account_name,
                        bank_name: depositRecord.bank_name,
                        currency: depositRecord.currency,
                        user_email: state.session.user.email,
                        status: 'completed'
                    }]);

                    if (insertError) {
                        showAlert('បរាជ័យ', 'បរាជ័យក្នុងការបង្កើតទិន្នន័យដកប្រាក់: ' + insertError.message, () => focusInput('withdraw_invoice'));
                        btn.disabled = false; btn.innerText = 'ទូទាត់ដកប្រាក់';
                        return;
                    }

                    const { data: updatedData, error: updateError } = await supabase
                        .from('transactions')
                        .update({ status: 'completed', withdrawn_by: state.session.user.email })
                        .eq('id', depositRecord.id)
                        .select();

                    if (updateError) {
                        showAlert('ព្រមាន', 'Error updating deposit status: ' + updateError.message, () => focusInput('withdraw_invoice'));
                    } else if (updatedData && updatedData.length === 0) {
                        showAlert('បញ្ហាសិទ្ធិ', 'ប្រព័ន្ធមិនអាចកែប្រែស្ថានភាពវេរចូលចាស់បានទេ។', () => focusInput('withdraw_invoice'));
                    } else {
                        showAlert('ជោគជ័យ', 'ដកប្រាក់ជោគជ័យ!', () => focusInput('withdraw_invoice'));
                        document.getElementById('withdraw_invoice').value = '';
                    }
                    btn.disabled = false; btn.innerText = 'ទូទាត់ដកប្រាក់';
                }, () => focusInput('withdraw_invoice')); 
                
                return;
            }

            // --- B. STANDARD FORM ---
            const invoiceNumber = document.getElementById('invoice_number').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const accountName = document.getElementById('account_name').value;
            const bankSelect = document.getElementById('bank_name');
            const bankName = bankSelect.options[bankSelect.selectedIndex].text;
            const status = document.getElementById('status_select').value;
            const currency = document.getElementById('currency_select').value;

            if (!invoiceNumber) {
                showAlert('ជូនដំណឹង', 'សូមបញ្ចូលលេខវិក្កយបត្រ', () => focusInput('invoice_number'));
                btn.disabled = false; btn.innerText = isEditing ? 'កែប្រែទិន្នន័យ' : 'រក្សាទុក';
                return;
            }

            if (!isEditing || (isEditing && invoiceNumber !== state.editingTx.invoice_number)) {
                const { data: existing } = await supabase
                    .from('transactions')
                    .select('id')
                    .eq('transaction_type', 'deposit') 
                    .eq('invoice_number', invoiceNumber)
                    .maybeSingle();

                if (existing) {
                    if (!isEditing || existing.id !== state.editingTx.id) {
                        showAlert('បរាជ័យ', 'លេខវិក្កយបត្រនេះមាននៅក្នុងប្រព័ន្ធរួចហើយ!', () => focusInput('invoice_number'));
                        btn.disabled = false; btn.innerText = isEditing ? 'កែប្រែទិន្នន័យ' : 'រក្សាទុក';
                        return;
                    }
                }
            }

            const formData = {
                invoice_number: invoiceNumber,
                amount: amount,
                account_name: accountName,
                bank_name: bankName,
                currency: currency,
                status: status,
            };

            if (!isEditing) {
                formData.transaction_type = 'deposit'; 
                formData.user_email = state.session.user.email;
                
                const { error } = await supabase.from('transactions').insert([formData]);
                if (error) {
                    showAlert('បរាជ័យ', error.message, () => focusInput('invoice_number'));
                } else {
                    state.showForm = false;
                    renderDashboardContent();
                    fetchTransactions();
                    showAlert('ជោគជ័យ', 'រក្សាទុកជោគជ័យ!');
                }
            } else {
                const { error } = await supabase.from('transactions').update(formData).eq('id', state.editingTx.id);
                if (error) showAlert('បរាជ័យ', 'កែប្រែមិនបានសម្រេច: ' + error.message, () => focusInput('invoice_number'));
                else {
                    showAlert('ជោគជ័យ', 'កែប្រែទិន្នន័យជោគជ័យ!');
                    state.editingTx = null;
                    state.showForm = false;
                    renderDashboardContent();
                    fetchTransactions();
                }
            }
            btn.disabled = false;
        }

        // --- CRUD ACTIONS: SETTINGS ---

        window.prepareEditSetting = (table, id) => {
            let item;
            if(table === 'banks') item = state.banks.find(i => i.id === id);
            else if(table === 'currencies') item = state.currencies.find(i => i.id === id);
            else if(table === 'posts') item = state.posts.find(i => i.id === id);

            if(item) {
                state.editingSetting = { table, ...item };
                renderSettingsContent();
            }
        };

        window.cancelEditSetting = () => {
            state.editingSetting = null;
            renderSettingsContent();
        }

        async function saveSetting(table, inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            if(!value) return;

            const isEditing = state.editingSetting && state.editingSetting.table === table;
            
            let payload = {};
            if(table === 'currencies') payload.code = value;
            else if(table === 'posts') {
                payload.title = value; 
                if(document.getElementById('post-content')) payload.content = document.getElementById('post-content').value;
            }
            else payload.name = value;

            let error;
            if(isEditing) {
                const { error: err } = await supabase.from(table).update(payload).eq('id', state.editingSetting.id);
                error = err;
            } else {
                const { error: err } = await supabase.from(table).insert([payload]);
                error = err;
            }

            if(error) showAlert('បរាជ័យ', error.message);
            else {
                if(inputId) document.getElementById(inputId).value = '';
                if(document.getElementById('post-content')) document.getElementById('post-content').value = '';
                state.editingSetting = null;
                
                if(table === 'banks') await fetchBanks();
                if(table === 'currencies') await fetchCurrencies();
                if(table === 'posts') await fetchPosts();
                
                renderSettingsContent();
            }
        }

        async function deleteSettingItem(table, id) {
            showConfirm('បញ្ជាក់', 'តើអ្នកពិតជាចង់លុបមែនទេ?', async () => {
                const { error } = await supabase.from(table).delete().eq('id', id);
                if(error) showAlert('បរាជ័យ', error.message);
                else {
                    if(table === 'banks') await fetchBanks();
                    if(table === 'posts') await fetchPosts();
                    if(table === 'currencies') await fetchCurrencies();
                    renderSettingsContent();
                }
            });
        }

        async function setDefault(table, id) {
            const rpcName = table === 'banks' ? 'set_default_bank' : 'set_default_currency';
            const { error } = await supabase.rpc(rpcName, { row_id: id });
            
            if(error) {
                console.error("RPC Error:", error);
                showAlert('បរាជ័យ', 'មិនអាចកំណត់លំនាំដើមបានទេ: ' + error.message);
            } else {
                if(table === 'banks') await fetchBanks();
                if(table === 'currencies') await fetchCurrencies();
                renderSettingsContent();
            }
        }

        // Users
        async function updateUserRole(userId, newRole) {
            const { error } = await supabase.from('profiles').update({ role: newRole }).eq('id', userId);
            if(error) showAlert('បរាជ័យ', error.message);
            else fetchUsers();
        }

        async function deleteUser(userId) {
            showConfirm('បញ្ជាក់', 'ការលុបនេះនឹងដកសិទ្ធិប្រើប្រាស់របស់ User នេះ។ តើអ្នកច្បាស់ទេ?', async () => {
                const { error } = await supabase.from('profiles').delete().eq('id', userId);
                if(error) showAlert('បរាជ័យ', error.message);
                else fetchUsers();
            });
        }

        // --- NAVIGATION & UI ---
        function switchTab(tab) {
            state.activeTab = tab;
            state.showForm = false;
            state.editingTx = null; 
            state.filterUser = ''; // Reset filter on tab change
            renderDashboard();
            if(tab === 'settings') fetchUsers(); 
            else fetchTransactions();
        }

        function toggleForm() { 
            state.showForm = !state.showForm; 
            if(!state.showForm) state.editingTx = null;
            renderDashboardContent(); 
            
            if(state.showForm) {
                setTimeout(() => {
                    const input = document.getElementById('invoice_number');
                    if(input) input.focus();
                }, 100);
            }
        }
        function toggleAuthMode() { state.authMode = state.authMode === 'login' ? 'signup' : 'login'; renderAuth(); }

        function renderLoading() {
            document.getElementById('app').innerHTML = `<div class="flex items-center justify-center h-screen"><div class="loader"></div></div>`;
        }

        function renderAuth() {
            const isLogin = state.authMode === 'login';
            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-slate-100 p-4">
                    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                        <h1 class="text-2xl font-bold text-center mb-6 text-blue-800">ប្រព័ន្ធគ្រប់គ្រងវេរប្រាក់</h1>
                        <form id="auth-form" class="space-y-4">
                            <input type="email" id="email" required placeholder="Email" class="w-full p-4 border rounded-lg text-lg outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="password" id="password" required placeholder="Password" class="w-full p-4 border rounded-lg text-lg outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" id="auth-btn" class="w-full bg-blue-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition">${isLogin ? 'ចូលប្រើប្រាស់' : 'ចុះឈ្មោះ'}</button>
                        </form>
                        <p class="text-center mt-6 text-blue-600 cursor-pointer text-lg" onclick="toggleAuthMode()">
                            ${isLogin ? 'ចុះឈ្មោះគណនេយ្យថ្មី' : 'ចូលប្រើប្រាស់គណនេយ្យដែលមានស្រាប់'}
                        </p>
                    </div>
                </div>`;
            document.getElementById('auth-form').addEventListener('submit', handleAuth);
        }

        function renderDashboard() {
            const isAdmin = state.role === 'admin';
            document.getElementById('app').innerHTML = `
                <div class="flex flex-col h-screen bg-gray-100 font-sans">
                    <!-- Top Header Area (Fixed) -->
                    <div class="bg-white shadow-sm z-50 sticky top-0">
                        <div class="flex justify-between items-center px-4 py-3 border-b border-gray-100">
                            <h1 class="text-2xl font-black text-blue-600 tracking-tight">MoneyTransfer</h1>
                            <div class="flex items-center gap-3">
                                <div class="hidden sm:flex bg-gray-100 px-3 py-1 rounded-full text-xs font-bold text-gray-600 items-center gap-1">
                                    <i data-lucide="${isAdmin ? 'shield' : 'user'}" class="w-3 h-3"></i>
                                    ${state.session.user.email.split('@')[0]}
                                </div>
                                <button onclick="handleLogout()" class="bg-gray-200 p-2 rounded-full hover:bg-gray-300 transition">
                                    <i data-lucide="log-out" class="w-5 h-5 text-gray-700"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Navigation Tabs -->
                        <div class="flex justify-around items-center">
                            <button onclick="switchTab('quick_withdraw')" class="flex-1 py-3 flex justify-center items-center relative group">
                                <i data-lucide="zap" class="w-7 h-7 ${state.activeTab === 'quick_withdraw' ? 'text-blue-600' : 'text-gray-500 group-hover:bg-gray-50'}"></i>
                                ${state.activeTab === 'quick_withdraw' ? '<div class="absolute bottom-0 w-full h-1 bg-blue-600 rounded-t-lg"></div>' : ''}
                            </button>

                            ${isAdmin ? `
                            <button onclick="switchTab('deposit')" class="flex-1 py-3 flex justify-center items-center relative group">
                                <i data-lucide="arrow-down-circle" class="w-7 h-7 ${state.activeTab === 'deposit' ? 'text-blue-600' : 'text-gray-500 group-hover:bg-gray-50'}"></i>
                                ${state.activeTab === 'deposit' ? '<div class="absolute bottom-0 w-full h-1 bg-blue-600 rounded-t-lg"></div>' : ''}
                            </button>` : ''}

                            <button onclick="switchTab('withdraw_reports')" class="flex-1 py-3 flex justify-center items-center relative group">
                                <i data-lucide="file-text" class="w-7 h-7 ${state.activeTab === 'withdraw_reports' ? 'text-blue-600' : 'text-gray-500 group-hover:bg-gray-50'}"></i>
                                ${state.activeTab === 'withdraw_reports' ? '<div class="absolute bottom-0 w-full h-1 bg-blue-600 rounded-t-lg"></div>' : ''}
                            </button>

                            ${isAdmin ? `
                            <button onclick="switchTab('settings')" class="flex-1 py-3 flex justify-center items-center relative group">
                                <i data-lucide="menu" class="w-7 h-7 ${state.activeTab === 'settings' ? 'text-blue-600' : 'text-gray-500 group-hover:bg-gray-50'}"></i>
                                ${state.activeTab === 'settings' ? '<div class="absolute bottom-0 w-full h-1 bg-blue-600 rounded-t-lg"></div>' : ''}
                            </button>` : ''}
                        </div>
                    </div>

                    <!-- Main Content -->
                    <main id="main-content" class="flex-1 overflow-y-auto bg-gray-100 p-4 pb-20"></main>
                </div>`;
            lucide.createIcons();
            renderDashboardContent();
        }

        function renderDashboardContent() {
            const container = document.getElementById('main-content');
            if (state.activeTab === 'settings') {
                renderSettingsContent();
                return;
            }

            const isDeposit = state.activeTab === 'deposit';
            const isWithdrawReports = state.activeTab === 'withdraw_reports';
            const isQuickWithdraw = state.activeTab === 'quick_withdraw';
            const isAdmin = state.role === 'admin';
            
            const isEditing = !!state.editingTx;
            const editData = state.editingTx || {};

            // 1. STANDARD FORM
            const standardFormHtml = `
                <div class="bg-white p-4 md:p-8 rounded-xl shadow-sm border border-gray-100 max-w-3xl mx-auto">
                    <h3 class="text-xl font-bold mb-6 flex gap-2 items-center text-blue-800 border-b pb-4">
                        <i data-lucide="edit" class="w-5 h-5"></i> ${isEditing ? 'កែប្រែទិន្នន័យ' : 'បញ្ចូលទិន្នន័យវេរចូល'}
                    </h3>
                    <form id="transaction-form" class="flex flex-col gap-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex flex-col gap-2">
                                <label class="text-sm font-bold text-gray-700">លេខវិក្កយបត្រ (Invoice)</label>
                                <input type="text" id="invoice_number" class="w-full p-4 border rounded-lg text-lg bg-gray-50 focus:bg-white transition" placeholder="INV-001" required value="${editData.invoice_number || ''}" inputmode="text">
                            </div>
                            <div class="flex flex-col gap-2">
                                <label class="text-sm font-bold text-gray-700">ចំនួនទឹកប្រាក់ ($)</label>
                                <input type="number" id="amount" step="0.01" class="w-full p-4 border rounded-lg text-lg font-bold text-blue-600 bg-gray-50 focus:bg-white transition" required placeholder="0.00" value="${editData.amount || ''}" inputmode="decimal">
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-bold text-gray-700">ឈ្មោះគណនេយ្យ</label>
                            <input type="text" id="account_name" class="w-full p-4 border rounded-lg text-lg bg-gray-50 focus:bg-white transition" placeholder="ឈ្មោះអតិថិជន" value="${editData.account_name || ''}" inputmode="text">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex flex-col gap-2">
                                <label class="text-sm font-bold text-gray-700">ធនាគារ</label>
                                <div class="relative">
                                    <select id="bank_name" class="w-full p-4 border rounded-lg text-lg bg-white appearance-none cursor-pointer">
                                        <option value="">ជ្រើសរើសធនាគារ</option>
                                        ${state.banks.map(b => `<option value="${b.id}" ${(isEditing ? (b.name === editData.bank_name) : b.is_default) ? 'selected' : ''}>${b.name}</option>`).join('')}
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-500"><i data-lucide="chevron-down"></i></div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2">
                                 <label class="text-sm font-bold text-gray-700">រូបិយប័ណ្ណ</label>
                                 <div class="relative">
                                     <select id="currency_select" class="w-full p-4 border rounded-lg text-lg bg-white appearance-none cursor-pointer">
                                        ${state.currencies.map(c => `<option value="${c.code}" ${(isEditing ? (c.code === editData.currency) : c.is_default) ? 'selected' : ''}>${c.code}</option>`).join('')}
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-500"><i data-lucide="chevron-down"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-bold text-gray-700">ស្ថានភាព</label>
                            <div class="relative">
                                <select id="status_select" class="w-full p-4 border rounded-lg text-lg bg-white font-medium text-gray-700 appearance-none">
                                    <option value="pending" ${editData.status === 'pending' ? 'selected' : ''}>មិនទាន់ដក</option>
                                    <option value="completed" ${editData.status === 'completed' ? 'selected' : ''}>បានដក(គណនេយ្យ)</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-500"><i data-lucide="chevron-down"></i></div>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-4 pt-4 border-t">
                            <button type="button" onclick="toggleForm()" class="flex-1 py-3 bg-gray-100 text-gray-800 rounded-lg font-bold text-lg hover:bg-gray-200 transition">បោះបង់</button>
                            <button type="submit" id="submit-tx-btn" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold text-lg hover:bg-blue-700 shadow-sm transition">
                                ${isEditing ? 'កែប្រែទិន្នន័យ' : 'រក្សាទុក'}
                            </button>
                        </div>
                    </form>
                </div>`;

            // 2. QUICK WITHDRAW FORM
            const quickWithdrawFormHtml = `
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-sm border border-gray-200 max-w-xl mx-auto mt-2">
                    <h3 class="text-xl font-bold mb-6 flex gap-2 items-center text-gray-800 border-b border-gray-100 pb-4">
                        <i data-lucide="zap" class="w-6 h-6 text-blue-600"></i> ដកប្រាក់រហ័ស
                    </h3>
                    <form id="transaction-form" class="flex flex-col gap-6">
                        <div class="flex flex-col gap-3">
                            <label class="text-lg font-bold text-gray-700 text-center">បញ្ចូលលេខវិក្កយបត្រ (Invoice)</label>
                            <input type="text" id="withdraw_invoice" class="w-full p-5 border-2 border-gray-300 rounded-xl text-2xl text-center font-mono focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition uppercase" placeholder="INV..." required inputmode="text">
                        </div>
                        <div class="flex flex-col gap-3 mt-4">
                            <button type="submit" id="submit-tx-btn" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-xl hover:bg-blue-700 shadow-md transition active:scale-[0.98] flex items-center justify-center gap-2">
                                <i data-lucide="search" class="w-5 h-5"></i> ស្វែងរក & ទូទាត់
                            </button>
                        </div>
                    </form>
                </div>`;

            let activeFormHtml;
            if (isEditing) activeFormHtml = standardFormHtml;
            else if (isQuickWithdraw) activeFormHtml = quickWithdrawFormHtml;
            else activeFormHtml = standardFormHtml; 

            // CENTERED POSTS
            const postsHtml = state.posts.length > 0 ? `
                <div class="flex flex-col items-center gap-4 mb-6 w-full">
                    ${state.posts.map(post => `
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500 hover:shadow-md transition w-full max-w-2xl">
                            <div class="flex items-start gap-3">
                                <div class="bg-blue-50 p-2 rounded-full text-blue-600 shrink-0"><i data-lucide="megaphone" class="w-5 h-5"></i></div>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg">${post.title}</h4>
                                    <p class="text-sm text-gray-600 mt-1 leading-relaxed">${post.content || ''}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '';

            // Table HTML
            const allowAdd = isAdmin && isDeposit; 
            let bodyContent = '';

            if (isQuickWithdraw) {
                bodyContent = `
                    <div class="max-w-6xl mx-auto space-y-4">
                        ${postsHtml}
                        ${activeFormHtml}
                    </div>
                `;
            } else {
                const title = isDeposit ? 'បញ្ជីវេរចូល' : 'របាយការណ៍ដកប្រាក់';
                
                // --- REPORTS SUMMARY LOGIC ---
                let summaryHtml = '';
                if (isWithdrawReports) {
                    // Filter logic for summary
                    let reportData = state.transactions;
                    if (isAdmin && state.filterUser) {
                        reportData = state.transactions.filter(t => t.user_email === state.filterUser);
                    }
                    // For Normal user, RLS already limits data to their own, so reportData is correct.

                    const totalCount = reportData.length;
                    
                    // Group by currency
                    const totalsByCurrency = reportData.reduce((acc, curr) => {
                        const currCode = curr.currency || 'USD';
                        acc[currCode] = (acc[currCode] || 0) + curr.amount;
                        return acc;
                    }, {});

                    const totalAmountStr = Object.entries(totalsByCurrency)
                        .map(([curr, amt]) => `<div class="font-mono text-blue-600">${amt.toFixed(2)} <span class="text-xs text-gray-500">${curr}</span></div>`)
                        .join('') || '<div class="text-gray-400">0.00</div>';

                    // Filter Dropdown for Admin
                    let filterHtml = '';
                    if (isAdmin) {
                        // Extract unique users from all loaded transactions (since Admin sees all)
                        const uniqueUsers = [...new Set(state.transactions.map(t => t.user_email))];
                        filterHtml = `
                            <div class="mb-4">
                                <select onchange="setFilterUser(this.value)" class="w-full sm:w-auto p-2 border rounded-lg bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                                    <option value="">បង្ហាញទិន្នន័យសរុប (All Users)</option>
                                    ${uniqueUsers.map(email => `<option value="${email}" ${state.filterUser === email ? 'selected' : ''}>${email}</option>`).join('')}
                                </select>
                            </div>
                        `;
                    }

                    summaryHtml = `
                        <div class="mb-6 space-y-4">
                            ${filterHtml}
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                                    <span class="text-gray-500 text-xs uppercase font-bold tracking-wider">ចំនួនវិក្កយបត្រ</span>
                                    <span class="text-2xl font-bold text-gray-800 mt-1">${totalCount}</span>
                                </div>
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                                    <span class="text-gray-500 text-xs uppercase font-bold tracking-wider">ទឹកប្រាក់សរុប</span>
                                    <div class="mt-1 text-xl font-bold flex flex-col items-center">
                                        ${totalAmountStr}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                bodyContent = `
                    <div class="max-w-6xl mx-auto">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <h2 class="text-xl font-bold text-gray-800">${title}</h2>
                            ${allowAdd ? `
                                <button onclick="toggleForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-bold shadow-sm active:scale-95 transition text-sm">
                                    <i data-lucide="${state.showForm?'list':'plus'}" class="w-4 h-4"></i> 
                                    <span>${state.showForm?'បញ្ជី':'បន្ថែម'}</span>
                                </button>` 
                            : ''}
                        </div>
                        
                        ${summaryHtml}

                        ${!allowAdd && !state.showForm && isDeposit ? '<div class="bg-blue-50 text-blue-800 p-3 rounded-lg mb-4 text-sm border border-blue-100 flex gap-2"><i data-lucide="eye" class="w-4 h-4 mt-0.5"></i> Read Only Mode</div>' : ''}
                        
                        ${state.showForm ? activeFormHtml : `
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <thead class="bg-gray-50 text-xs uppercase text-gray-500 font-semibold tracking-wider">
                                            <tr>
                                                <th class="p-4 whitespace-nowrap">កាលបរិច្ឆេទ</th>
                                                <th class="p-4 whitespace-nowrap">Invoice</th>
                                                <th class="p-4 whitespace-nowrap text-right">ទឹកប្រាក់</th>
                                                <th class="p-4 whitespace-nowrap">ឈ្មោះ</th>
                                                <th class="p-4 whitespace-nowrap">ធនាគារ</th>
                                                ${isDeposit ? '<th class="p-4 text-center whitespace-nowrap">ស្ថានភាព</th>' : ''}
                                                <th class="p-4 whitespace-nowrap">User</th>
                                                ${isAdmin ? '<th class="p-4 text-right whitespace-nowrap">សកម្មភាព</th>' : ''}
                                            </tr>
                                        </thead>
                                        <tbody id="transaction-table-body" class="text-sm divide-y divide-gray-100"></tbody>
                                    </table>
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }

            container.innerHTML = bodyContent;
            
            lucide.createIcons();
            
            if(isQuickWithdraw) {
               focusInput('withdraw_invoice');
            }

            if(document.getElementById('transaction-form')) document.getElementById('transaction-form').addEventListener('submit', handleTransactionSubmit);
            
            if (!isQuickWithdraw && !state.showForm && state.transactions.length > 0) {
                renderTransactionTable();
            } else if (!isQuickWithdraw && !state.showForm && state.transactions.length === 0) {
                 const tbody = document.getElementById('transaction-table-body');
                 if(tbody) {
                     tbody.innerHTML = '<tr><td colspan="8" class="p-12 text-center text-gray-400 flex flex-col items-center gap-2"><i data-lucide="inbox" class="w-12 h-12 opacity-50"></i><span>គ្មានទិន្នន័យ</span></td></tr>'; 
                     lucide.createIcons();
                 }
            }
        }

        // ... (Rest of settings content and renderTransactionTable - no changes needed there) ...
        function renderSettingsContent() {
            const container = document.getElementById('main-content');
            
            const renderConfigSection = (title, items, table, placeholder, fieldName = 'name') => {
                const isEditing = state.editingSetting && state.editingSetting.table === table;
                const editValue = isEditing ? (state.editingSetting[fieldName] || state.editingSetting.code) : '';
                
                return `
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2 text-gray-700">${title}</h3>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-${table}" placeholder="${placeholder}" class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${editValue}">
                        ${isEditing ? 
                            `<button onclick="saveSetting('${table}', 'new-${table}')" class="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700 font-medium">Update</button>
                             <button onclick="cancelEditSetting()" class="bg-gray-100 text-gray-700 px-4 rounded-lg hover:bg-gray-200 font-medium">Cancel</button>`
                            : 
                            `<button onclick="saveSetting('${table}', 'new-${table}')" class="bg-green-600 text-white px-4 rounded-lg hover:bg-green-700 font-medium">បន្ថែម</button>`
                        }
                    </div>
                    <ul class="space-y-2">
                        ${items.map(item => `
                            <li class="flex justify-between items-center bg-gray-50 p-3 rounded-lg group hover:bg-gray-100 transition">
                                <div class="flex items-center gap-3">
                                    <button onclick="setDefault('${table}', '${item.id}')" title="Set as Default">
                                        <i data-lucide="star" class="w-5 h-5 ${item.is_default ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300 hover:text-yellow-400'}"></i>
                                    </button>
                                    <span class="font-medium text-gray-700">${item.name || item.code}</span>
                                </div>
                                <div class="flex gap-2 opacity-100 sm:opacity-50 group-hover:opacity-100 transition-opacity">
                                    <button onclick="prepareEditSetting('${table}', '${item.id}')" class="text-blue-500 hover:bg-blue-100 p-1 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                    <button onclick="deleteSettingItem('${table}', '${item.id}')" class="text-red-500 hover:bg-red-100 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>`;
            };

            const postSection = `
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <h3 class="font-bold text-lg mb-4 border-b pb-2 text-gray-700">ព័ត៌មាន & ពាណិជ្ជកម្ម (Posts)</h3>
                    <div class="space-y-3 mb-4 border p-4 rounded-lg bg-gray-50">
                        <input type="text" id="post-title" placeholder="ចំណងជើង (Title)" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${state.editingSetting?.table === 'posts' ? state.editingSetting.title : ''}">
                        <textarea id="post-content" placeholder="ខ្លឹមសារ (Content)" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" rows="2">${state.editingSetting?.table === 'posts' ? state.editingSetting.content : ''}</textarea>
                        <div class="flex gap-2">
                            ${state.editingSetting?.table === 'posts' ? 
                                `<button onclick="saveSetting('posts', 'post-title')" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">Update Post</button>
                                 <button onclick="cancelEditSetting()" class="w-1/3 bg-gray-100 text-gray-700 py-3 rounded-lg font-bold">Cancel</button>`
                                : 
                                `<button onclick="saveSetting('posts', 'post-title')" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">បង្ហោះ Post</button>`
                            }
                        </div>
                    </div>
                    <div class="space-y-3">
                        ${state.posts.map(post => `
                            <div class="bg-white border rounded-lg p-3 flex justify-between items-start group hover:shadow-sm transition">
                                <div>
                                    <h4 class="font-bold text-sm text-gray-800">${post.title}</h4>
                                    <p class="text-xs text-gray-500 mt-1">${post.content || '-'}</p>
                                </div>
                                <div class="flex flex-col gap-2 opacity-100 sm:opacity-50 group-hover:opacity-100">
                                    <button onclick="prepareEditSetting('posts', '${post.id}')" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                    <button onclick="deleteSettingItem('posts', '${post.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            const userSection = `
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                         <h3 class="font-bold text-lg text-gray-700">គ្រប់គ្រងអ្នកប្រើប្រាស់ (Users)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50">
                                <tr><th class="p-3 text-gray-600">Email</th><th class="p-3 text-gray-600">Role</th><th class="p-3 text-right text-gray-600">Actions</th></tr>
                            </thead>
                            <tbody class="divide-y">
                                ${state.users.map(u => `
                                    <tr>
                                        <td class="p-3 font-medium text-gray-700">${u.email.split('@')[0]}</td>
                                        <td class="p-3">
                                            <select onchange="updateUserRole('${u.id}', this.value)" class="border rounded p-1 text-xs ${u.role==='admin'?'text-blue-600 font-bold bg-blue-50':''}">
                                                <option value="user" ${u.role==='user'?'selected':''}>User</option>
                                                <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
                                            </select>
                                        </td>
                                        <td class="p-3 text-right">
                                            <button onclick="deleteUser('${u.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash" class="w-4 h-4"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;

            container.innerHTML = `
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 px-1">ការកំណត់ (Settings)</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            ${postSection}
                            ${renderConfigSection('ធនាគារ (Banks)', state.banks, 'banks', 'ឈ្មោះធនាគារ')}
                            ${renderConfigSection('រូបិយប័ណ្ណ (Currencies)', state.currencies, 'currencies', 'Code (e.g. THB)', 'code')}
                        </div>
                        <div>
                            ${userSection}
                        </div>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        function renderTransactionTable() {
            const tbody = document.getElementById('transaction-table-body');
            if(!tbody) return;
            
            // FILTER FOR TABLE VIEW
            let displayData = state.transactions;
            if (state.activeTab === 'withdraw_reports' && state.role === 'admin' && state.filterUser) {
                displayData = state.transactions.filter(t => t.user_email === state.filterUser);
            }

            if(displayData.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="8" class="p-12 text-center text-gray-400 flex flex-col items-center gap-2"><i data-lucide="inbox" class="w-12 h-12 opacity-50"></i><span>គ្មានទិន្នន័យ</span></td></tr>'; 
                lucide.createIcons(); 
                return; 
            }
            
            const isDeposit = state.activeTab === 'deposit';
            const isAdmin = state.role === 'admin';

            tbody.innerHTML = displayData.map(tx => {
                const isCompleted = tx.status === 'completed';
                const badgeClass = isCompleted 
                    ? 'bg-green-100 text-green-700 border-green-200' 
                    : 'bg-yellow-100 text-yellow-700 border-yellow-200';
                
                const withdrawer = tx.withdrawn_by ? tx.withdrawn_by.split('@')[0] : 'គណនេយ្យ';
                const badgeText = isCompleted ? `បានដក(${withdrawer})` : 'មិនទាន់ដក';

                const statusCell = isDeposit ? `
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-bold border ${badgeClass}">
                            ${badgeText}
                        </span>
                    </td>
                ` : '';

                const actionCell = isAdmin ? `
                    <td class="p-4 text-right">
                        <div class="flex justify-end gap-3">
                            <button onclick="editTransaction('${tx.id}')" class="text-blue-600 hover:text-blue-800 transition" title="Edit">
                                <i data-lucide="pencil" class="w-5 h-5"></i>
                            </button>
                            <button onclick="deleteTransaction('${tx.id}')" class="text-red-600 hover:text-red-800 transition" title="Delete">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </td>
                ` : '';

                return `
                <tr class="hover:bg-blue-50/50 transition border-b group">
                    <td class="p-4 whitespace-nowrap text-gray-700">${new Date(tx.created_at).toLocaleDateString('km-KH')}</td>
                    <td class="p-4 font-mono text-blue-600 text-xs font-bold bg-gray-50 rounded px-2 w-fit">${tx.invoice_number || '-'}</td>
                    <td class="p-4 text-right font-bold ${isDeposit ? 'text-green-600' : 'text-red-600'} whitespace-nowrap">
                        ${isDeposit?'+':'-'} ${tx.amount.toFixed(2)} <span class="text-xs text-gray-500 font-normal">${tx.currency || ''}</span>
                    </td>
                    <td class="p-4 font-medium text-gray-800">${tx.account_name || '-'}</td>
                    <td class="p-4"><span class="bg-white border border-gray-200 px-2 py-1 rounded text-xs font-medium text-gray-600 shadow-sm">${tx.bank_name || 'N/A'}</span></td>
                    ${statusCell}
                    <td class="p-4 text-xs text-gray-500 truncate max-w-[100px]" title="${tx.user_email}">${tx.user_email.split('@')[0]}</td>
                    ${actionCell}
                </tr>
            `}).join('');
            
            if(isAdmin) lucide.createIcons();
        }

        initApp();
    </script>
</body>
</html>
